<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoParts - Catálogo</title>
    <link rel="stylesheet" href="/css/client.css">
    <link rel="icon" type="image/jpeg" href="/img/favicon.jpg">
</head>
<body>

    <%- include('partials/nav') %>

    <main>
        <div class="section-header" style="margin-bottom: 2rem; background: none; padding-left: 0;">
            <h1 style="margin: 0;">Catálogo de Productos <%= locals.usuario ? '(Admin)' : '' %></h1>
        </div>

        <% if (productos && productos.length > 0) { %>
            <div class="grid">
                <% productos.forEach(prod => { %>
                    <% if (locals.usuario || prod.activo == 1) { %>
                        <div class="card">
                            <img src="<%= prod.imagen %>" alt="<%= prod.nombre %>" onerror="this.src='https://via.placeholder.com/200?text=Sin+Imagen'">
                            <div class="card-body">
                                <h4><%= prod.nombre %></h4>
                                <p class="price" style="font-weight: bold;">$<%= prod.precio %></p>
                                
                                <% if (locals.usuario) { %>
                                    <p style="font-size: 0.8rem; color: #666; display: flex; align-items: center; gap: 5px;">
                                        Activo:
                                        <% if (prod.activo == 1) { %>
                                            <span style="height: 10px; width: 10px; background-color: var(--success); border-radius: 50%; display: inline-block;"></span>
                                        <% } else { %>
                                            <span style="height: 10px; width: 10px; background-color: var(--danger); border-radius: 50%; display: inline-block;"></span>
                                        <% } %>
                                    </p>
                                    <div class="controls" style="margin-top: 10px;">
                                        <a href="/modificar?id=<%= prod.id %>" class="btn-link" style="background: #ffc107; color: black; padding: 6px 12px; border-radius: 4px; text-decoration: none; font-size: 0.9rem;">Editar</a>
                                        <% if (prod.activo == 1) { %>
                                            <button type="button" onclick="deleteProduct(<%= prod.id %>)" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Eliminar</button>
                                        <% } else { %>
                                            <button type="button" onclick="activateProduct(<%= prod.id %>)" style="background: green; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">Reactivar</button>
                                        <% } %>
                                    </div>
                                <% } else { %>
                                    <div class="controls" style="margin-top: 10px;">
                                        <button type="button" onclick="addToCartLocal('<%= prod.id %>', '<%= prod.nombre %>', '<%= prod.precio %>', '<%= prod.imagen %>')" style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; width: 100%;">
                                            Agregar al Carrito
                                        </button>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    <% } %>
                <% }) %>
            </div>
        <% } else { %>
            <p style="text-align: center; color: #666;">No hay productos cargados.</p>
        <% } %>
    </main>

    <%- include('partials/footer') %>

    <script>
        // Lógica Admin
        async function deleteProduct(id) {
            if (!confirm("¿Eliminar producto?")) return;
            const res = await fetch(`/api/products/${id}`, { method: "DELETE" });
            if (res.ok) window.location.reload();
        }
        async function activateProduct(id) {
            if (!confirm("¿Reactivar producto?")) return;
            const res = await fetch(`/api/products/${id}/activate`, { method: "PUT" });
            if (res.ok) window.location.reload();
        }

        // Lógica Cliente (Carrito Local)
        function addToCartLocal(id, nombre, precio, imagen) {
            let cart = [];
            try { cart = JSON.parse(localStorage.getItem("cart")) || []; } catch(e) { cart = []; }
            
            const found = cart.find(item => item.id == id);
            if (found) {
                alert("Ya tienes este producto en el carrito.");
            } else {
                cart.push({ id, nombre, precio, quantity: 1, imagen });
                localStorage.setItem("cart", JSON.stringify(cart));
                alert("✅ " + nombre + " agregado al carrito");
            }
        }
    </script>

</body>
</html>